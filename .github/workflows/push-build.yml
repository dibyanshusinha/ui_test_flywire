name: Main Tests

# Manually triggered via:
#   1. PR/issue comment containing "Please run tests"
#   2. GitHub Actions UI (workflow_dispatch)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    # For issue_comment: only run on PR comments (not issue comments) that say "Please run tests"
    # For workflow_dispatch: always run
    if: |
      github.event_name == 'workflow_dispatch' || (
        github.event.issue.pull_request != null &&
        contains(github.event.comment.body, 'Please run tests')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Run Unit Tests with coverage
        run: npm run test:coverage

      - name: Run E2E tests with coverage
        run: npm run e2e:coverage
