name: Main Tests

# Manually triggered via:
#   1. PR/issue comment containing "Please run tests" â€” by repo members only
#   2. GitHub Actions UI (workflow_dispatch)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    # For issue_comment:
    #   - Only run on PR comments (not plain issue comments)
    #   - Comment must contain the trigger phrase
    #   - Commenter must be a repo member, collaborator, or owner (prevents
    #     any external user from burning CI minutes by commenting on a public repo)
    # For workflow_dispatch: always run
    if: |
      github.event_name == 'workflow_dispatch' || (
        github.event.issue.pull_request != null &&
        contains(github.event.comment.body, 'Please run tests') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Run Unit Tests with coverage
        run: npm run test:coverage

      - name: Run E2E tests with coverage
        run: npm run e2e:coverage
