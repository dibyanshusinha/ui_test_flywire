name: Label PR

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  pull-requests: write

jobs:
  label-type:
    name: Apply type label
    runs-on: ubuntu-latest
    steps:
      - name: Apply labels from labeler.yml
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  label-size:
    name: Apply size label
    runs-on: ubuntu-latest
    steps:
      - name: Calculate PR size and apply label
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const lines = pr.additions + pr.deletions;
            const sizeLabels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];

            let label;
            if (lines < 10)       label = 'size/XS';
            else if (lines < 100) label = 'size/S';
            else if (lines < 300) label = 'size/M';
            else if (lines < 500) label = 'size/L';
            else                  label = 'size/XL';

            // Remove any existing size labels then apply the correct one
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            for (const l of currentLabels) {
              if (sizeLabels.includes(l.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: l.name,
                });
              }
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label],
            });

            core.info(`Applied label: ${label} (${lines} lines changed)`);
